<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gaea.work.qna">

	<delete id="deleteByCreatedDateBefore">
		<![CDATA[
		DELETE FROM board WHERE reg_dt < #{date}
		 ]]>
	</delete>

	<sql id="searchKeyWord" >
		<where>
			<if test="searchKeyword != null and searchKeyword != ''">
				 title like '%' || #{searchKeyword} || '%'
				 OR content like '%' || #{searchKeyword} || '%'
			</if>
		</where>
	</sql>
	
	<select id="qnaCount" resultType="int">
        SELECT COUNT(*) FROM board
    </select>
	
	<select id="pagingList" parameterType="java.util.HashMap" resultType="QnaVO">
	    <![CDATA[
	    SELECT * FROM (
	        SELECT iq.*, ROWNUM AS rnum
	        FROM (
	            SELECT
	                board_seq,
	                member_id,
	                title,
	                content,
	                like_cnt,
	                read_cnt,
	                reg_dt,
	                DECODE(TO_CHAR(mod_dt,'YYYYMMDD'), TO_CHAR(SYSDATE,'YYYYMMDD')
                      ,TO_CHAR(mod_dt,'HH24:MI')
                      ,TO_CHAR(mod_dt,'YYYY-MM-DD')) as modDt
	            FROM
	                board
	            ORDER BY mod_dt DESC
	        ) iq
	        WHERE ROWNUM <= #{end}
	    )
	    WHERE rnum >= #{start}
	    ]]>
	</select>


	<update id="updateLikeCnt" parameterType="QnaVO">
	    <![CDATA[
	    UPDATE board
	       SET like_cnt = NVL(like_cnt,0)+1
	     WHERE board_seq  = #{boardSeq}
	       AND member_id <> #{memberId} ]]>  
	</update>

	<update id="updateReadCnt" parameterType="QnaVO">
       	 <![CDATA[
	    UPDATE board
	       SET read_cnt = NVL(read_cnt,0)+1
	     WHERE board_seq  = #{boardSeq}
	       AND member_id <> #{memberId} ]]> 
    </update>

	<delete id="deleteAllQna" parameterType="QnaVO" >
	    DELETE FROM board
	    WHERE title LIKE #{title}||'%'
	</delete>

	<!-- 게시글 등록 -->
	<insert id="saveArticle" parameterType="QnaVO">
		INSERT INTO board (
		    board_seq,
		    member_id,
		    title,
		    content,
		    like_cnt,
		    read_cnt,
		    reg_dt,
		    mod_dt
		) VALUES (
		    BOARD_SEQ.NEXTVAL,
		    #{memberId},
		    #{title},
		    #{content},
		    #{likeCnt},
		    #{readCnt},
		    SYSDATE,
		    SYSDATE
		)
	</insert>
	
	<!-- 게시글 한건 조회 -->
	<select id="selectOneArticle" parameterType="QnaVO" resultType="QnaVO">
		SELECT
		    board_seq,
		    member_id,
		    title,
		    content,
		    like_cnt,
		    read_cnt,
		    reg_dt,
		    mod_dt
		FROM
		    board
		WHERE board_seq = #{boardSeq}    
	</select>
	
	<!-- 게시물 수정 -->
	<update id="updateArticle" parameterType="QnaVO">
		UPDATE board
		SET
			title = #{title},
			content = #{content},
			mod_dt = SYSDATE
		WHERE
		    board_seq = #{boardSeq}
	</update>
	
	<!-- 게시물 삭제 -->
	<delete id="deleteArticle" parameterType="QnaVO">
		DELETE FROM board WHERE board_seq = #{boardSeq}
	</delete>
	
	<!-- 전체 게시물 조회 -->
    <select id="retrieveArticle" parameterType="QnaVO" resultType="QnaVO">
    <![CDATA[
        SELECT * FROM (
            SELECT 
                board_seq as boardSeq,
                member_id as memberId,
                title,
                content,
                like_cnt as likeCnt,
                read_cnt as readCnt,
                DECODE(TO_CHAR(mod_dt,'YYYYMMDD'), TO_CHAR(SYSDATE,'YYYYMMDD')
                      ,TO_CHAR(mod_dt,'HH24:MI')
                      ,TO_CHAR(mod_dt,'YYYY-MM-DD')) as modDt,
                ROWNUM as rnum
            FROM 
                (SELECT 
                    board_seq,
                    member_id,
                    title,
                    content,
                    like_cnt,
                    read_cnt,
                    mod_dt
                FROM 
                    board    ]]>
                <include refid="searchKeyWord" /> <![CDATA[
                ORDER BY 
                    mod_dt DESC
                ) 
            WHERE ROWNUM <= #{limit}
        )
        WHERE rnum > #{start}
    ]]>
    </select>    
		
</mapper>